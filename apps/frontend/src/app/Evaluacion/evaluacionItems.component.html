<div class="d-flex flex-column align-items-center mb-4">
  <app-header></app-header>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="d-flex justify-content-center mt-4">
  <div class="col-lg-9 col-md-10 col-12 contenedor-listado">
    <div class="card mt-3">

      <!-- HEADER DE LA CARD -->
      <div class="card-header header-transparente mb-4">
        <div class="text-center mb-4">
          <h2 class="titulo-seccion">
            Detalle Evaluaci贸n del Agente
          </h2>
        </div>


        <div class="row gx-3 gy-2 mt-3 justify-content-center">
          <div class="col-md-6" *ngIf="cabecera?.periodo">
            <div class="d-flex align-items-center border rounded shadow-sm bg-light text-dark">
              <div class="px-2 py-1 text-muted fw-semibold" style="min-width: 150px;">
                Per铆odo:
              </div>
              <div class="px-2 py-1">
                {{ cabecera.periodo | date:'MM/yyyy' }}
              </div>
            </div>
          </div>

          <div class="col-md-6" *ngIf="cabecera?.agenteevaluador">
            <div class="d-flex align-items-center border rounded shadow-sm bg-light text-dark">
              <div class="px-2 py-1 text-muted fw-semibold" style="min-width: 150px;">
                Agente Evaluador:
              </div>
              <div class="px-2 py-1">
                {{ cabecera.agenteevaluador.nombreUsuarioEvaluador }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BLOQUE AGENTE EVALUADO -->
      <div class="border rounded bg-light p-3 d-flex flex-column">

        <div class="text-center mb-3">
          <h6 class="fw-bold mb-1">Agente Evaluado:</h6>
          <p class="fw-bold fs-5 mb-0 text-primary">
            {{ nombreAgenteEvaluado }}
          </p>
        </div>

        <!-- FILA: BOTN VOLVER + TOTALES -->
        <div class="d-flex justify-content-between align-items-start gap-2">

          <!-- Bot贸n Volver a la izquierda -->
          <div>
            <button class="btn btn-outline-secondary me-2" (click)="volver()" title="Volver">
              <i class="fas fa-door-open"></i>
            </button>


          </div>

          <!-- Totales a la derecha -->
          <div class="d-flex align-items-start gap-2">

            <!-- Promedio -->
            <div class="d-flex flex-column text-end" style="flex: 0 0 80px;">
              <label for="promedioActual" class="form-label fw-bold mb-1 small text-center"
                     style="line-height: 1; display: block;">
                Prom:
              </label>

              <input type="text" id="promedioActual" class="form-control form-control-sm text-center px-1 py-1"
                     style="font-size: .75rem; height: calc(1.5em + .5rem);" [(ngModel)]="promedioPuntajes"
                     [ngModelOptions]="{standalone: true}" readonly>
            </div>

            <!-- Items evaluados -->
            <div class="d-flex flex-column text-end" style="flex: 0 0 90px;">
              <label for="itemsEvaluados" class="form-label fw-bold mb-1 small text-center"
                     style="line-height: 1; display: block;">
                tems:
              </label>

              <input type="text" id="itemsEvaluados" class="form-control form-control-sm text-center px-1 py-1"
                     style="font-size: .75rem; height: calc(1.5em + .5rem);" [(ngModel)]="totalItemsConValor"
                     [ngModelOptions]="{standalone: true}" readonly>
            </div>

            <!-- Total Puntaje -->
            <div class="d-flex flex-column text-end" style="flex: 0 0 90px;">
              <label for="totalPuntaje" class="form-label fw-bold mb-1 small text-center"
                     style="line-height: 1; display: block;">
                Total:
              </label>

              <input type="text" id="totalPuntaje" class="form-control form-control-sm text-center px-1 py-1"
                     style="font-size: .75rem; height: calc(1.5em + .5rem);" [(ngModel)]="sumaPuntajes"
                     [ngModelOptions]="{standalone: true}" readonly>
            </div>

          </div>
        </div>

      </div>

      <!-- BODY: CATEGORIAS E ITEMS -->
      <div class="card-body p-3">
        <div *ngIf="categorias.length > 0; else sinItems">

          <div *ngFor="let categoria of categorias; let i = index" class="mb-4">
            <h5 class="fw-bold text-dark">{{ categoria.descripcionCategoria }}</h5>

            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="thead-light" *ngIf="i === 0">
                  <tr>
                    <th class="d-none">ID tem</th>
                    <th>Descripci贸n</th>
                    <th class="text-center">Puntaje</th>
                    <th class="text-center">Evaluar</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of categoria.items">
                    <td class="d-none">{{ item._id }}</td>
                    <td>{{ item.descripcion }}</td>
                    <td class="text-center">{{ item.puntaje }}</td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-success ms-2" (click)="evaluarItem(item)">
                        <i class="bi bi-file-earmark-text"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <ng-template #sinItems>
          <p class="text-center text-muted">No hay 铆tems de evaluaci贸n para mostrar.</p>
        </ng-template>
      </div>

      <!-- MODAL -->
      <div *ngIf="mostrarModalValor" class="modal-backdrop-custom">
        <div class="custom-modal">
          <div class="custom-modal-header">
            <h5 class="modal-title"> Ingresar valor para 铆tem</h5>
            <button type="button" class="close" (click)="cerrarModalValor()">
              <span>&times;</span>
            </button>
          </div>

          <div class="custom-modal-body">
            <div class="mb-3">
              <label class="form-label fw-semibold">Valor del tem</label>
              <div class="text-muted">{{ itemSeleccionado?.descripcion }}</div>
            </div>

            <div class="d-flex align-items-center gap-3"
                 style="border: 1px solid #ced4da; border-radius: 8px; background-color: #f8f9fa; padding: 12px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
              <label for="valorItem" class="mb-0 fw-semibold text-dark">Valor:</label>
              <input type="number" class="form-control form-control-sm" id="valorItem" [(ngModel)]="valorIngresado"
                     placeholder="0000" style="width: 100px;" max="9999" />
            </div>
          </div>

          <div class="custom-modal-footer text-end">
            <button class="btn btn-secondary" (click)="cerrarModalValor()">Cancelar</button>
            <button class="btn btn-primary" (click)="guardarValor()">Guardar</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>